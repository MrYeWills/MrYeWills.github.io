---
title: d3缓存笔记
date: {{ date }}
tags: [d3.js, svg]
categories: 
- 前端
---

## d3知识
### d3文档介绍
#### d3各版本变化
[官网英文](https://github.com/d3/d3/blob/master/CHANGES.md)

### d3小知识点或技巧
#### 比例尺
序数比例尺与线性比例尺用的最多；
序数比例尺用来做x轴；线性做y轴；

#### d3的图形与布局
柱状图、折线图、散点图 是d3常见的图形。
除以上三种图形外，还有很多图形他们位置不固定（还有其他说法），比如饼图，饼图可以在任意位置，这个时候，就需要一种其他的画图方式，这种方式就是d3的布局。
d3的布局用法为 d3.layout.pie,d3的布局有12种，饼图是其中最简单一个。

#### d3的坐标轴方向
如图，d3的坐标轴，默认原点在左上角，y的正值是向下的。
![](/image/d3/all/axio.jpg)

### 生成坐标轴
#### 概述和代码
坐标轴一般用比例尺来做，用到比例尺就要用到两个概念 domain 与 range。
domain为实际数据范围，range为坐标轴的刻度范围，这个刻度范围是用来表示数据范围的。
所以数据范围与刻度范围形成一定比例。

以下都基于以下两个demo：
[参考demo一](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/BarChart-full.html)
[参考demo二](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/LineChart.html)

生成坐标轴的完整代码如下：
代码如下：
```
const dataset = [50, 43, 120, 87, 99, 167, 142];
//scaleBand生成序数分段比例尺，x轴通常使用scaleBand
const xScale = d3.scaleBand().domain(dataset.map((d, i) => i)).range([0, xAxisWidth]).padding(0.1);
//scaleLinear生成线性比例尺，y轴通常使用这个
const yScale = d3.scaleLinear().domain([d3.max(dataset, d => d), 0]).range([0, yAxisWidth]);

//生成底部轴线
const xAxis = d3.axisBottom(xScale);
//生成左侧轴线
const yAxis = d3.axisLeft(yScale);

//设置轴线偏移位置
const gx = svg.append('g').attr('transform', `translate(${padding.left},${height - padding.bottom})`);
const gy = svg.append('g').attr('transform', `translate(${padding.left},${height - padding.bottom - yAxisWidth})`);
gx.call(xAxis);
gy.call(yAxis);
```
#### 生成比例尺的方法 scaleLinear\scaleBand
这两个方法都是生成比例尺的方法，见《概述和代码》 
#### domain range
见《概述和代码》；
除代码中外，还可以这样用：
```
const xScale = d3.scaleBand().domain([1,2,3,4]).range([11,23,25,67]);
xScale(2)//23  一一对应关系
```
#### ticks 不是一个确数
ticks设置坐标轴的刻度数量，但不是你设置几个，最终显示几个，d3会自动设置在设置数的上下。
参考《groud 与 g》的demo
#### domain range 的单位
如下， domain是值域，没有单位，纯粹代表数值大小；range是地域范围，单位是px，用来限定坐标轴占地面积大小。
demo 参考《groud 与 g》的demo。
```
var scalewidth = d3.scale.linear()
                        .domain([0,80])
                        .range([0,500])
```


### 生成折线图
#### 概述
如图，坐标轴生成代码同《生成坐标轴》。下面的代码主要介绍生成折线图的折线。
[demo地址](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/LineChart.html)
[视频讲解](https://www.bilibili.com/video/av13729975/?spm_id_from=333.788.videocard.1)
![](/image/d3/all/liner.jpg)
```
//使用d3的方法来生成折线的path
 const linePath = d3.line().x((d, i) => xScale(i) + padding.left + xScale.bandwidth() / 2)
            .y(d => height - padding.bottom - (yScale(0) - yScale(d)));
//将数据传给上面写好的 d3生成线的path方法，避免手动写繁杂的path(而这正是d3的本职工作)
const line = svg.append('path').attr('d', linePath(dataset)).attr('stroke', '#000')
        .attr('stroke-width', '3px').attr('fill', 'none');
```
#### 手工写生成折线的path
svg的path手动写非常繁杂，手工写不现实，而这正是d3存在的原因之一，d3提供了丰富的方法用于生成path,也就是下面介绍到的d3.line()。
#### d3.line()生成折线
参考本节的《概述》

### 生成直方图
#### 概述
如图，坐标轴生成代码同《生成坐标轴》。
直方图主要是绘制矩形柱状图 和 text的显示，具体下来就是如何确定柱状图的 x、y坐标，宽高度。
[demo地址](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/BarChart-full.html)
[视频讲解](https://www.bilibili.com/video/av13492121/?spm_id_from=333.788.videocard.0)

![](/image/d3/all/barchart.jpg)
```
 //标尺
const xScale = d3.scaleBand().domain(dataset.map((o, i) => i))
.range([0, xAxisWidth]).padding(0.1);
const yScale = d3.scaleLinear().domain([0, d3.max(dataset)]).rangeRound([yAxisWidth, 0]);
//绘制矩形柱状图 的方法，
const updateRect = svg.selectAll("rect").data(dataset)      
        .attr("fill", (d, i) => color(i))
        .attr("x", (d, i) => padding.left + xScale(i))
        .attr("y", (d, i) => height - padding.bottom)
        .attr("width", xScale.bandwidth())
        .attr("height", 0)
        .transition().duration(1000)  //重新赋值y，height 过渡效果
        .attr("y", (d, i) => height - padding.bottom - (yScale(0) - yScale(d)))
        .attr("height", d => yScale(0) - yScale(d));
```
#### 设置x，y坐标、宽高度
见上面代码
#### svg的rect与text的运用
见上面代码
#### 标尺与柱状图的绘制密切联系
本示例中，柱状图的x、y坐标的确定与标尺xScale等相关联，这也是坐标轴图的套路，上面的《生成折线图》也有映射。
#### update、enter、exit的经典运用
详见上面提到的demo地址，这个简洁demo介绍了这三种状态的渲染。

### 生成饼状图
#### 饼状图的一些概念
- outerRadius 外半径
- innerRadius 内半径
- startAngle 起始角度
- endAngle 结束角度
![](/image/d3/all/pie1.jpg)
#### 单段饼图
```
 const svg = d3.select("#svg").append("svg").attr("width", "300").attr("height", "300");
const dataset = {startAngle:0, endAngle: Math.PI*0.75};
const arcPath = d3.arc()  //弧生成器
        .innerRadius(50)   //设置内半径
        .outerRadius(100);  //设置外半径
svg.append("path")
        .attr("d", arcPath(dataset)) // 用弧生成器生成弧线数据，赋值给SVG的d属性
        .attr("transform", 'translate(200, 200)') // 填充颜色
        .attr("stroke", '#000').attr('stroke-width', '3px') // 填充颜色
        .attr("fill", 'blue') // 填充颜色
```
效果如图：
![](/image/d3/all/pie2.jpg)
#### 多个饼图拼成一个完整饼图
一个饼图其实是由上面说到的一个个分段的饼图拼接而成：
``` const svg = d3.select("#svg").append("svg").attr("width", "300").attr("height", "300");
        const pie = d3.pie();
        const dataset = [30, 10, 43, 55, 13];
        const piedata = pie(dataset);
        const outerRadius = 150; //外半径
        const innerRadius = 0; //内半径，为0则中间没有空白
        const arc = d3.arc()  //弧生成器
            .innerRadius(innerRadius)   //设置内半径
            .outerRadius(outerRadius);  //设置外半径
        const arcs = svg.selectAll("g") // 存放弧的容器
            .data(piedata) //绑定pie数据
            .enter() // 数据进入
            .append("g") // 生成g
            .attr("transform", "translate(" + (300 / 2) + "," + (300 / 2) + ")"); // 偏移
        const color = d3.scaleOrdinal(d3.schemeCategory10);
        arcs.append("path")
            .attr("fill", (d, i) => color(i)) // 填充颜色
            .attr("d", d => {
                return arc(d)
            }); // 用弧生成器生成弧线数据，赋值给SVG的d属性
        arcs.append("text")
            .attr("transform", d => "translate(" + arc.centroid(d) + ")") // 设置文本至扇区中心
            .attr("text-anchor", "middle") //设置文本锚点
            .attr("fill", "#fff") //设置文字颜色
            .text(d => d.data);
```
![](/image/d3/all/pie3.jpg)

#### 获取圆弧中心点
[主要运用arc的centroid API](https://github.com/d3/d3-3.x-api-reference/blob/master/SVG-Shapes.md#arc)：
```
var arcFn = d3.svg.arc()
			.innerRadius(innerRadius)
			.outerRadius(outerRadius);

arcs.append("text")
	.attr("class","MyText")
	.attr("transform", function(d){
		var center = arcFn.centroid(d);
		return "translate(" + 
			center[0] * 1.4 + "," + 
			center[1] * 1.4 + ")";
	})
```
[参考demo --- 功能更丰富的的完整饼图](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/wangjingzhi/sixth.html)

#### demo地址与参考
[单段饼图 demo地址](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/PieChart.html)
[完整饼图 demo地址](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/my-d3-practice/PieCharts.html)
[视频讲解](https://www.bilibili.com/video/av13872208/?spm_id_from=333.788.videocard.0)

[功能更丰富的的完整饼图](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/wangjingzhi/sixth.html)

### 生成线段
完整代码如下，主要运用d3.svg.line，另外interpolate是生成不同类型连接线类型的，[参考文档](https://github.com/d3/d3-3.x-api-reference/blob/master/SVG-Shapes.md#_line)
```
//v3.x
var svg = d3.select("body").append("svg")
		.attr("width", 400)
		.attr("height", 400);
var data = [
		{"x": 10, "y": 200},
		{"x": 50, "y": 260},
		{"x": 90, "y": 120}
	]
	var line = d3.svg.line()
			.x( function(d){ return d.x; } )
			.y( function(d){ return d.y; } )
			.interpolate("line");
	svg.append("path")
		.attr("class","MyPath")
		.attr("d", line(data) )
```

### 生成散点图
#### 概述
散点图比较简单，主要代码如下，[demo地址点击这里](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/wangjingzhi/fifth.html)。

这里要注意的是比例尺与圆心cx cy的结合使用。
```
//v3.x

var xScale = d3.scale.linear()
				.domain([0, 100])
				.range([0,300]);

var points = svg.selectAll(".MyCircle")
				.data(dataset)
				.enter()
				.append("circle")
				.attr("class","MyCircle")
				.attr("transform","translate(30,50)")
				.attr("r", 10)
				.attr("cx", function(d){ return xScale(d.x); })
				.attr("cy", function(d){ return yScale(d.y); });
```
#### 比例尺与圆心cx cy的结合使用
参考上面。

### scale比例尺的作用
#### 没有比例尺
如下，没有比例尺时，下面两个柱形图太长了，而svg只是一个500*500的容器，大于500的，无法显示，为了自适应，引入比例尺。
```
var canvas = d3.select("body")
                .append("svg")
                .attr("width",500)
                .attr("height",500);
var bar1= canvas.selectAll("rect")
            .data([20,40,60,80,150])
            .enter()
                .append("rect")
                .attr("width",function(d) { return d*8})
                .attr("height",30)
                .attr("y",function(d, i) { return (i+1)*65; })
```
![](/image/d3/all/scale.jpg)

#### 使用比例尺
```
//d3.scale.linear比例尺
 var scalewidth = d3.scale.linear()
        .domain([0,140])
        .range([0,500])
var bar1= canvas.selectAll("rect")
            .data([20,40,60,80,150])
            .enter()
                .append("rect")
                //使用比例尺来生成width
                .attr("width",function(d) { return scalewidth(d)})
                .attr("height",30)
                .attr("y",function(d, i) { return (i+1)*65; })
```
![](/image/d3/all/scale2.jpg)

### groud 与 g
#### 分组 与 div
groud就是分组，缩写就是 g，这也是d3上常用到的g标签。
如下面代码，加g后，可以统一设置g分组内的所有rect，所有g相当于html中的div
```
 var scalewidth = d3.scale.linear()
                        .domain([0,80])
                        .range([0,500])

    var axis = d3.svg.axis()
                  .ticks(10)
                  .scale(scalewidth)

    var canvas = d3.select("body")
                  .append("svg")
                  .attr("width",500)
                  .attr("height",500)
                  // 这里是否加g进行分组，效果是一样的，但是加g后，可以在g上统一对下面的rect设置样式：
                  .append("g")

    var color = d3.scale.linear()
                    .domain([0,140])
                    .range(["red","blue"])

    var bar1= canvas.selectAll("rect")
                .data([20,40,60,80,])
                .enter()
                    .append("rect")
                    .attr("width",function(d) { return scalewidth(d)})
                    .attr("height",40)
                    .attr("fill",function(d) { return color(d)})
                    .attr("y",function(d) { return d * 3});
```
#### 例子二 -- 坐标轴是否分组
对上面的代码进行延伸，加一个坐标轴，坐标轴分组和不分组，区别很大，分组后，更容易设置样式。
```
var canvas = d3.select("body")
                  .append("svg")
                  .attr("width",500)
                  .attr("height",500)
                  .append("g")
                  // 不推荐写法---未将坐标轴分组，不容易设置样式：
                  //   .call(axis)
                  ;
            // 推荐写法---将坐标轴分组，更容易设置样式：
            // canvas.append("g")
            //         .attr("transform","translate(0,300)")
            //         .call(axis)
```
#### demo地址
[demo地址](https://github.com/YeWills/nodemon-server-template/blob/d3-demo/pages/mars/lesson6/test01.html)

## svg知识
### 常见的svg标签
```
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600" version="1.1">
    <defs>
        <marker id="marker" markerWidth="10" markerHeight="10" refX="4" refY="4" orient="auto">
            <path d="M 0 0 4 4 0 8" style="fill:none;stroke:black;"/>
        </marker>
    </defs>
    //矩形  --可用于生成直方图
    <rect width="200" height="100" x="20" y="20" style="fill:red;stroke:blue;stroke-width:4"/>
    <rect width="200" height="100" x="250" y="20" rx="20" ry="20" style="fill:red;stroke:blue;stroke-width:4"/>
    <circle cx="100" cy="280" r="80" style="fill:yellow"/>
    //椭圆
    <ellipse cx="330" cy="280" rx="100" ry="80" style="fill:yellow"/>
    //直线
    <line x1="0" x2="360" y1="0" y2="360" style="stroke:#000;stroke-width:4;marker-end:url(#marker);"/>
    //三角形
    <polygon points="100,20 20,90 20,200" style="fill:green;stroke:orange;stroke-width:4"/>
    //折线
    <polyline points="100,20 20,90 20,200" style="fill:green;stroke:orange;stroke-width:4" transform="translate(100,0)"/>
    <text x="200" y="150" style="fill:purple;font-size:60;" textLength="300">
        I love <tspan fill="green">D3.js</tspan>
    </text>
    //万能path，能画任何线条
    <path d="M 200 200 A 200 200 0 0 1 400 400" style="fill:none;stroke:orange;stroke-width:10;" />
</svg>
```
### xmlns 与 version
xmlns是固定写法，固定值如下，version也是固定写法，最近的版本就是1.1:
```
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600" version="1.1">
</svg>
```
### path 指令
这里只列举部分，[更多参考](https://www.bbsmax.com/A/A7zgmMwW54/)：
```
指令 	参数 	说明
M	x y	将画笔移动到点(x,y)
L	x y	画笔从当前的点绘制线段到点(x,y)
H	x	画笔从当前的点绘制水平线段到点(x,y0)
V	y 	画笔从当前的点绘制竖直线段到点(x0,y)
A	rx ry x-axis-rotation large-arc-flag sweep-flag x y	画笔从当前的点绘制一段圆弧到点(x,y)
C	x1 y1, x2 y2, x y	画笔从当前的点绘制一段三次贝塞尔曲线到点(x,y)
```
```
 <path d="M 200 200 A 200 200 0 0 1 400 400" style="fill:none;stroke:orange;stroke-width:10;" />
```
### path的贝塞尔曲线
ps工具中的钢笔工具就是一个贝塞尔曲线，贝塞尔曲线由几个点组成，[具体参考这个视频的末尾段的介绍](https://www.bilibili.com/video/av13105102/?spm_id_from=333.788.videocard.3)

## 参考
[视频教程有7个，在这个网站上是能找到这七个视频的](https://www.bilibili.com/video/av13492121/?spm_id_from=333.788.videocard.0)

