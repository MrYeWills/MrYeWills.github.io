---
title: nginx笔记(有)
date: 2021/6/22
tags: nginx
categories: 
- 前端工具
series: nginx
---

*有孚维心，亨，行有尚。*

## 基础知识
### 静态服务器和反向代理
nginx是一款静态服务器，可以自行处理客户端静态资源如js、css 等等的返回；
nginx并不能处理动态资源接口，所有的动态接口，如商品价格、库存量 等请求 都转发给 业务服务器，由业务服务器 返回给nginx，再由nginx返回给客户端。
这个过程中nginx起到一个代理的作用，上面的过程也是 nginx 反向代理的过程；
nginx 最重要的两个功能就是 静态服务器 和 反向代理；
其他的如负载均衡（当nginx作为代理时，当有多台服务器时，nginx如何将请求均衡发给多台服务器，达到负载均衡 性能优化），都是因此延伸出来。
![](/image/nginx/busi.png)
另外可参考《一个http请求的全流程》图片看反向代理。

反向代理其实就是 转发代理。

### nginx特点

#### nginx 特点介绍

- 高并发、高性能
nginx为 高并发而生；
通过 增加进程 来适应高并发；
通过合理设计 达到高性能

- 扩展性好

- 异步非阻塞的事件驱动模型

#### nginx相比apache的优势


apache是上一代服务器(当时的cpu也是单核的，apache也是根据这个单核cpu设计的,这个理由只当看看)，产生比较早，特点如下：
- 一个进程处理一个请求；
- 阻塞式的

nginx是最新一代服务器(根据当代多核cpu设计的,这个理由只当看看)，特点如下：
- 一个进程处理多个请求
- 非阻塞式的

因为以上两个特点，nginx也具有了高并发能力

###  nginx产生和流行的原因
互联网快速增长，高并发需求大，apache处理请求的低效性，导致了nginx 这种能高并发服务器的产生。


### 有关http请求相关
#### 一个http请求的全流程
如下：
- 请求发送到nginx，nginx响应静态资源；
- 动态请求，nginx作为反向代理：将请求发送给 应用服务器（就是后端人员写的服务器），再有应用服务器响应nginx，由nginx返回客户端。
- 应用服务器 接受请求后，请求DB 数据库服务器，对数据库进行增删改查，由数据库服务器响应最新数据给应用服务器。
![](/image/nginx/http.jpg)

#### nginx处理请求过程
对于下图说明：
- 静态服务器：公司通过在本地建立一个资源目录库，用于返回静态资源
- 大中型公司才会将 应用服务和数据库服务器进行分离，一般应用通常将应用服务器和数据库服务器放在同一个机器上，不用做数据库与应用服务器的分离；
- 静态资源响应很快，通常一段时间内能处理5万个请求，但一个动态请求因为要走反向代理 到 应用服务器 到数据库服务器 所以可能只能处理5000条数据，因此就有了性能优化的需求：
  - 比如 反向代理的时候，在nginx这里做缓存处理，相同的请求直接缓存返回，不需要往下请求，达到加速；
  - 当公司有多个应用服务器时，nginx不要将所有请求发送到一台机器，通过算法均衡发送，达到负载均衡；

- 数据库旁边的缓存服务，也是用于加速的服务器，可以不部署。

![](/image/nginx/http1.jpg)


### 使用信号量管理master和worker
#### linux中的常用信号量
```s
SIGHLD                  kill -17 pid   子进程down掉后，向其父进程发送的信号
SIGQUIT                 kill -3 pid    也是关闭进程
SIGTERM                 kill -15 pid  kill -15 和 kill 是一样的，kill 默认是15，关闭进程，等等进程当次处理完数据后关闭
SIGKILL                 kill -9 pid   不等待进程处理完数据，立即关闭
SIGHUP                  kill -1 pid  让程序重新读取配置文件
SIGUSER1                kill -10 pid  用户自定义信号量
SIGUSER2                kill -12 pid  用户自定义信号量
SIGWINCH                kill -28 pid  处理就的进程关闭
```

#### 信号量的两种用法
```s
如上，
kill -9 pidxxx 
也可以用
kill -s SIGKILL pidxxx  #s sign的缩写
```
nginx就是有一个master 主进程，和若干个 worker子进程构成的。

可以用信号量 管理 master进程；
worker进程一般是master进程控制的；
一般使用信号量管理master进程，进而让master进程管理子进程；
也可使用信号量直接管理worker子进程(虽然不推荐)，
为什么不推荐呢，因为一旦直接关闭子进程，子进程会让master进程发送信号，master然重新启动一个子进程。
master进程
worker进程
命令行

命令行可以操作下面操作：

reload 底层利用的是HUP信号量
reload 底层利用的是USER1信号量
stop 底层利用的是TERM信号量
quit 底层利用的是QUIT信号量

认识 nginx进程
nginx的配置文件
worker_processes auto; //自动识别电脑有几个cpu，下面的例子说明识别出4个进程
![](/image/nginx/pid.png)

nginx 配置文件重载原理
配置文件更改，
master主进程读取配置文件，检测是否有语法错误，若有，则不执行重载，
若无语法错误，master则立即生成新配置的子进程，同时通知老的子进程执行完后关闭。
此时就存在新的和老的子进程同时存在的情况。
什么是老的子进程执行完之后完毕，
比如，客户在浏览网页的时候，与老的子进程建立了连接，一直等客户关闭页面关闭连接，
老的子进程才退出。
![](/image/nginx/reload.png)


nginx热部署升级 的过程
![](/image/nginx/red.png)


## nginx 配置

### 配置文件结构
![](/image/nginx/in.png)


